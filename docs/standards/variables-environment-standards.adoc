= Variables & Environment Standards ‚Äî Azure Local Load Tools
Kristopher Turner
v1.0, 2026-02-13

:description: Standards for configuration variables, environment files, YAML structure, JSON schemas, and the override chain in the Azure Local Load Tools repository.
:keywords: variables, configuration, yaml, json, schema, environment, azure-local, override-chain
:toc: left
:toclevels: 4
:sectnums:
:icons: font
:source-highlighter: rouge
:experimental:
:imagesdir: ../images
:tip-caption: üí°
:note-caption: ‚ÑπÔ∏è
:warning-caption: ‚ö†Ô∏è
:caution-caption: üî•
:important-caption: ‚ùó

[abstract]
This document defines the mandatory standards for all configuration files, environment variables, YAML structures, JSON schemas, and the variable override chain in the Azure Local Load Tools repository.
Every configuration file must conform to these standards before merging.

[discrete]
== Quick Navigation

* <<configuration-file-hierarchy>> ‚Äî How config files relate to each other
* <<master-environment-file>> ‚Äî `master-environment.yml` structure and rules
* <<variable-definition-standards>> ‚Äî Naming, types, tags, categories
* <<solution-json-configs>> ‚Äî Auto-generated per-solution JSON files
* <<cluster-configuration>> ‚Äî Cluster YAML file standards
* <<workload-profiles>> ‚Äî Profile YAML format and conventions
* <<credential-configuration>> ‚Äî Key Vault mappings, never plaintext
* <<schema-validation>> ‚Äî JSON Schema requirements

'''

== Configuration File Hierarchy

The configuration system follows a layered architecture:

----
config/
‚îú‚îÄ‚îÄ variables/
‚îÇ   ‚îú‚îÄ‚îÄ master-environment.yml    <1>
‚îÇ   ‚îú‚îÄ‚îÄ schema.json               <2>
‚îÇ   ‚îî‚îÄ‚îÄ solutions/
‚îÇ       ‚îú‚îÄ‚îÄ vmfleet.json           <3>
‚îÇ       ‚îú‚îÄ‚îÄ fio.json
‚îÇ       ‚îú‚îÄ‚îÄ iperf.json
‚îÇ       ‚îú‚îÄ‚îÄ hammerdb.json
‚îÇ       ‚îî‚îÄ‚îÄ stress-ng.json
‚îú‚îÄ‚îÄ clusters/
‚îÇ   ‚îî‚îÄ‚îÄ example-cluster.yml       <4>
‚îú‚îÄ‚îÄ credentials/
‚îÇ   ‚îî‚îÄ‚îÄ keyvault-config.yml       <5>
‚îî‚îÄ‚îÄ profiles/
    ‚îî‚îÄ‚îÄ vmfleet/                   <6>
        ‚îú‚îÄ‚îÄ general.yml
        ‚îú‚îÄ‚îÄ peak-iops.yml
        ‚îú‚îÄ‚îÄ sql-oltp.yml
        ‚îî‚îÄ‚îÄ vdi.yml
----
<1> **Master source of truth** ‚Äî all variables defined here with solution tags
<2> **JSON Schema** ‚Äî validates the structure of `master-environment.yml`
<3> **Solution configs** ‚Äî auto-generated by `ConfigManager` from master file
<4> **Cluster configs** ‚Äî per-cluster connection details and topology
<5> **Credential config** ‚Äî maps logical names to Key Vault secrets
<6> **Workload profiles** ‚Äî preset parameter sets for common test scenarios

=== Data Flow

----
master-environment.yml
        ‚îÇ
        ‚ñº (ConfigManager filters by solution tag)
  solutions/*.json
        ‚îÇ
        ‚ñº (Script reads at runtime)
  Three-Level Override Chain:
    1. Explicit parameter  ‚Üí  highest priority
    2. Profile config      ‚Üí  middle priority
    3. Solution config     ‚Üí  lowest priority (default)
----

IMPORTANT: Variables flow in one direction only: master ‚Üí solution JSON ‚Üí runtime. Never edit solution JSON files by hand ‚Äî they are generated artifacts.

== Master Environment File

=== Location

`config/variables/master-environment.yml`

=== Required Structure

[source,yaml]
----
metadata:
  version: "1.0.0"                    # <1>
  description: "Master environment configuration for Azure Local Load Tools"
  last_modified: "2026-02-13"         # <2>

variables:                             # <3>
  - name: variable_name
    value: default_value
    type: string
    required: true
    description: "Human-readable description"
    solutions: [vmfleet, fio]
    category: cluster
----
<1> Semantic version ‚Äî increment on every change
<2> Update `last_modified` on every edit
<3> `variables` is an array of variable definition objects

=== Metadata Block

[cols="1,1,2"]
|===
| Field | Type | Description

| `version`
| string
| Semantic version (`major.minor.patch`)

| `description`
| string
| Purpose of this configuration file

| `last_modified`
| date
| ISO 8601 date of last modification
|===

WARNING: Always update `version` and `last_modified` when editing the master file. CI validation checks for stale dates.

== Variable Definition Standards

=== Required Fields

Every variable entry in `master-environment.yml` must include **all** of these fields:

[cols="1,1,1,3"]
|===
| Field | Type | Required | Description

| `name`
| string
| Yes
| Unique identifier in `snake_case`

| `value`
| any
| Yes
| Default value (empty string `""` or `[]` for unset)

| `type`
| string
| Yes
| One of: `string`, `integer`, `boolean`, `array`

| `required`
| boolean
| Yes
| Whether the variable must have a non-empty value at runtime

| `description`
| string
| Yes
| Human-readable explanation of the variable's purpose

| `solutions`
| array
| Yes
| List of solutions that consume this variable

| `category`
| string
| No
| Logical grouping (see <<variable-categories>>)

| `sensitive`
| boolean
| No
| If `true`, value must come from Key Vault at runtime
|===

=== Variable Naming Rules

[cols="1,3,2"]
|===
| Rule | Description | Example

| Format
| Always `snake_case`, lowercase
| `vm_count_per_node`

| Pattern
| `^[a-z][a-z0-9_]*$`
| Enforced by JSON Schema

| Solution prefix
| Use solution name as prefix for solution-specific variables
| `vmfleet_admin_username`, `hammerdb_db_name`

| Shared variables
| No prefix for variables shared across solutions
| `cluster_name`, `csv_path`

| Avoid abbreviations
| Use full words unless the abbreviation is universally understood
| `vm_memory_gb` not `vm_mem_gb`
|===

CAUTION: Variable names are used as JSON keys in solution configs. Renaming a variable is a breaking change ‚Äî update all scripts that reference it.

=== Variable Types

[cols="1,2,2"]
|===
| Type | YAML Value | JSON Equivalent

| `string`
| `"text value"`
| `"text value"`

| `integer`
| `42`
| `42`

| `boolean`
| `true` / `false`
| `true` / `false`

| `array`
| `[item1, item2]`
| `["item1", "item2"]`
|===

=== Solution Tags

The `solutions` field is an array of solution identifiers. Valid values:

* `vmfleet`
* `fio`
* `iperf`
* `hammerdb`
* `stress-ng`

A variable tagged with multiple solutions will appear in each solution's generated JSON:

[source,yaml]
----
- name: cluster_name
  value: ""
  type: string
  required: true
  description: "Azure Local cluster name"
  solutions: [vmfleet, fio, iperf, hammerdb, stress-ng]  # Shared across all
  category: cluster
----

[[variable-categories]]
=== Variable Categories

[cols="1,3"]
|===
| Category | Variables In This Group

| `cluster`
| Cluster identity, nodes, storage paths, network config

| `deployment`
| VM counts, memory, CPU, disk sizes

| `testing`
| Block sizes, write ratios, durations, thresholds

| `monitoring`
| Log Analytics workspace, collection intervals, Azure Monitor settings

| `reporting`
| Report formats, output paths, template paths

| `credentials`
| Usernames, passwords (sensitive ‚Äî Key Vault only)

| `logging`
| Log levels, retention, paths
|===

=== Sensitive Variables

Variables marked `sensitive: true` must follow these rules:

. The `value` field in master config must be empty (`""`)
. Actual values are retrieved at runtime from Azure Key Vault
. The mapping from variable name to Key Vault secret is in `keyvault-config.yml`
. Scripts must never write sensitive values to logs

[source,yaml]
----
- name: vmfleet_admin_password
  value: ""                     # <1>
  type: string
  required: true
  sensitive: true               # <2>
  description: "Password for VMFleet admin account"
  solutions: [vmfleet]
  category: credentials
----
<1> Always empty ‚Äî never store the actual password
<2> Marks this variable for Key Vault retrieval

CAUTION: Never commit actual credentials to any configuration file. The `.gitignore` should protect against this, but manual vigilance is still required.

== Solution JSON Configs

=== Generation

Solution JSON configs are **generated** by the `Export-SolutionConfig` function in `ConfigManager`:

[source,powershell]
----
Export-SolutionConfig -ConfigPath 'config/variables/master-environment.yml' `
    -Solution 'VMFleet' `
    -OutputPath 'config/variables/solutions/vmfleet.json'
----

=== Format

[source,json]
----
{
  "_metadata": {
    "generated_at": "2026-02-13T10:00:00Z",
    "solution": "VMFleet",
    "source": "config/variables/master-environment.yml",
    "variable_count": 25
  },
  "cluster_name": "",
  "cluster_domain": "",
  "vm_count_per_node": 10,
  "vmfleet_admin_username": "FleetAdmin"
}
----

=== Rules

. **Never edit by hand** ‚Äî these are generated artifacts
. **Always regenerate** after editing `master-environment.yml`
. **Commit the generated files** ‚Äî they are checked into source control for offline/airgapped use
. The `_metadata` block is informational and ignored by scripts

TIP: Run `Export-SolutionConfig` for all solutions after any master config change. The CI pipeline validates that generated files are in sync.

== Cluster Configuration

=== Location

`config/clusters/<cluster-name>.yml`

=== Required Structure

[source,yaml]
----
cluster:
  # Identity
  name: "hci-cluster-01"           # <1>
  domain: "contoso.local"
  description: "Production Azure Local cluster"

  # Nodes
  nodes:                            # <2>
    - name: "hci-node-01"
      management_ip: "10.0.0.1"
      storage_ip: "10.0.1.1"

  # Storage
  csv_path: "C:\\ClusterStorage\\Volume1"
  collect_volume_path: "C:\\ClusterStorage\\Collect"
  base_vhd_path: "C:\\ClusterStorage\\Collect\\BaseImage.vhdx"

  # WinRM
  winrm:                            # <3>
    port: 5985
    use_ssl: false
    authentication: "Kerberos"
    skip_ca_check: false
    operation_timeout_seconds: 300

  # Networks
  networks:                         # <4>
    management:
      subnet: "10.0.0.0/24"
      vlan_id: 0
    storage:
      subnet: "10.0.1.0/24"
      vlan_id: 100
      rdma_enabled: true
    compute:
      subnet: "10.0.2.0/24"
      vlan_id: 200

  # Linux VMs (for fio, iperf, stress-ng, hammerdb)
  linux_vms: []                     # <5>
----
<1> Cluster name must match the actual failover cluster name
<2> List every node ‚Äî used for remote command execution
<3> WinRM settings for PowerShell remoting into cluster nodes
<4> Network topology for network-aware testing (iPerf)
<5> Empty array for solutions not yet deployed

=== File Naming

* Use descriptive names: `prod-seattle-hci01.yml`, `lab-east-cluster.yml`
* The `example-cluster.yml` file is a **template** ‚Äî copy it, never edit it directly

WARNING: Cluster config files may contain IP addresses and hostnames. Do **not** commit production cluster configs with real IPs to a public repository. Use `.gitignore` or a separate private config repo.

== Workload Profiles

=== Location

`config/profiles/<solution>/<profile-name>.yml`

=== Required Structure

[source,yaml]
----
profile:
  name: "Peak IOPS"                              # <1>
  description: "100% random 4K reads for maximum IOPS measurement"
  category: "iops"                                # <2>

  parameters:                                      # <3>
    block_size: "4k"
    write_ratio: 0
    random_ratio: 100
    outstanding_io: 32
    threads_per_vm: 4
    duration_seconds: 300
    warmup_seconds: 60

  expected_thresholds:                             # <4>
    min_iops_per_node: 50000
    max_latency_ms: 10
    min_throughput_mbps: 200
----
<1> Human-readable profile name ‚Äî shown in reports
<2> Category for grouping (`iops`, `throughput`, `latency`, `mixed`, `oltp`, `olap`)
<3> Parameters that override solution config defaults when this profile is selected
<4> Optional thresholds for pass/fail reporting

=== Profile Naming Convention

[cols="2,3"]
|===
| Profile | Purpose

| `general.yml`
| Balanced mixed workload ‚Äî default if no profile specified

| `peak-iops.yml`
| Maximum IOPS (small random reads)

| `sql-oltp.yml`
| Simulates SQL Server OLTP patterns

| `vdi.yml`
| Simulates VDI (Virtual Desktop Infrastructure) patterns
|===

TIP: Create new profiles rather than modifying existing ones. Profiles are meant to be reusable presets.

== Credential Configuration

=== Location

`config/credentials/keyvault-config.yml`

=== Structure

[source,yaml]
----
keyvault:
  name: ""                          # <1>
  resource_group: ""
  subscription_id: ""
  tenant_id: ""

  auth_method: "az_cli"            # <2>

  service_principal:                # <3>
    client_id: ""
    client_secret_env_var: "AZURE_CLIENT_SECRET"
    tenant_id: ""

  secrets:                          # <4>
    cluster_admin_username: "hci-cluster-admin-user"
    cluster_admin_password: "hci-cluster-admin-pwd"
    vmfleet_admin_username: "vmfleet-admin-user"
    vmfleet_admin_password: "vmfleet-admin-pwd"
----
<1> Key Vault identity ‚Äî fill in when configuring for your environment
<2> Authentication method: `az_cli`, `managed_identity`, or `service_principal`
<3> Only needed for `service_principal` auth ‚Äî note the env var reference for the secret
<4> Maps logical names (used in scripts) to actual Key Vault secret names

=== Rules

[cols="1,3"]
|===
| Rule | Description

| No plaintext secrets
| The `secrets` block maps **names only** ‚Äî never actual values

| Environment variables
| Service principal secrets reference env vars, not literal values

| Auth method
| Use `az_cli` for local development, `managed_identity` for CI/CD

| Key Vault naming
| Secret names in Key Vault should use `kebab-case`
|===

IMPORTANT: The `keyvault-config.yml` file itself is safe to commit ‚Äî it contains only name mappings. The actual secrets live exclusively in Azure Key Vault.

== Schema Validation

=== Master Config Schema

The file `config/variables/schema.json` validates `master-environment.yml`:

[cols="2,3"]
|===
| Validation | Rule

| Variable name format
| `^[a-z][a-z0-9_]*$` (snake_case only)

| Variable type
| One of: `string`, `integer`, `boolean`, `array`

| Solutions array
| At least one solution from the allowed set

| Category values
| Must be from the defined set (cluster, deployment, testing, etc.)

| Required fields
| `name`, `value`, `type`, `required`, `description`, `solutions`

| No extra fields
| `additionalProperties: false` ‚Äî prevents typos
|===

=== Running Validation

[source,powershell]
----
# Validate master config structure
$config = Import-MasterConfig -Force

# Export and validate all solution configs
foreach ($solution in @('vmfleet', 'fio', 'iperf', 'hammerdb', 'stress-ng')) {
    Export-SolutionConfig -Solution $solution
}
----

NOTE: The CI pipeline (`validate-config.yml`) runs schema validation automatically on every PR that touches files under `config/`.

=== Adding New Variables

When adding a new variable, follow this checklist:

. Add the variable to `master-environment.yml` with all required fields
. Update `schema.json` if adding a new category or solution
. Regenerate the affected solution JSON configs
. Update any scripts that should consume the new variable
. Add the variable to the documentation appendix (Appendix A ‚Äî Variable Reference)
. Increment the metadata `version` and update `last_modified`
