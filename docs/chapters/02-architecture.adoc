== Solution Architecture

This chapter describes the overall architecture of the {project-name}, including component relationships, data flow, and integration points.

=== High-Level Architecture

// TODO: Export from docs/diagrams/solution-architecture.drawio
// image::solution-architecture.svg[Solution Architecture,width=100%,align=center]

The framework consists of five major layers:

[horizontal]
Configuration Layer:: Master environment variables, cluster configs, workload profiles, credential management
Automation Layer:: PowerShell modules, Ansible roles, orchestrator scripts
Execution Layer:: Load testing tools (VMFleet, fio, iPerf3, HammerDB, stress-ng) running on cluster nodes and VMs
Monitoring Layer:: PerfMon counter collection, Azure Monitor integration, real-time dashboards
Reporting Layer:: Metric aggregation, AsciiDoc template population, multi-format output generation

=== Configuration Flow

// TODO: Export from docs/diagrams/config-flow.drawio
// image::config-flow.svg[Configuration Flow,width=100%,align=center]

.Configuration Pipeline
[source,text]
----
master-environment.yml    →    ConfigManager Module    →    vmfleet.json
  (all variables,               (filters by              (only VMFleet
   tagged by solution)           solution tag)             variables)
----

The `ConfigManager` PowerShell module reads the master environment file, filters variables by their solution tags, and generates solution-specific JSON files. Downstream scripts consume only the generated JSON — never the master YAML directly.

=== Component Diagram

.Core Components
[cols="1,2,1"]
|===
| Component | Responsibility | Location

| ConfigManager
| Variable management, filtering, override chain
| `src/core/powershell/modules/ConfigManager/`

| Logger
| Structured JSON-lines logging with correlation IDs
| `src/core/powershell/modules/Logger/`

| StateManager
| Run state tracking, checkpoints, resume capability
| `src/core/powershell/modules/StateManager/`

| CredentialManager
| KeyVault, interactive, or parameter-based credential retrieval
| `src/core/powershell/modules/CredentialManager/`

| MonitoringManager
| PerfMon collection, Azure Monitor push
| `src/core/powershell/modules/MonitoringManager/`

| ReportGenerator
| PDF, DOCX, XLSX report generation
| `src/core/powershell/modules/ReportGenerator/`
|===

=== VMFleet Automation Workflow

// TODO: Export from docs/diagrams/vmfleet-workflow.drawio
// image::vmfleet-workflow.svg[VMFleet Workflow,width=100%,align=center]

The VMFleet orchestrator executes the following phases:

. **Pre-Check** — Validate cluster connectivity, S2D health, CSV availability, base VHD
. **Install** — Install VMFleet PowerShell module, create Collect volume
. **Deploy** — Create fleet VMs with configured vCPU and memory settings
. **Test** — Execute workload profiles (General, Peak IOPS, VDI, SQL OLTP)
. **Monitor** — Collect storage, network, and compute metrics in parallel
. **Collect** — Parse DiskSpd XML results, aggregate metrics per profile per node
. **Report** — Generate PDF, DOCX, and XLSX reports from collected data
. **Cleanup** — (Optional) Remove fleet VMs and volumes

Each phase is checkpoint-tracked via `StateManager`, enabling resume after failure.

=== Network Topology

// TODO: Export from docs/diagrams/network-topology.drawio
// image::network-topology.svg[Network Topology,width=100%,align=center]

A typical Azure Local cluster deployment includes:

* **Management Network** — Cluster management, PowerShell remoting, monitoring traffic
* **Storage Network** — RDMA/SMB Direct traffic between cluster nodes (dedicated NICs)
* **Compute/VM Network** — Virtual machine workload traffic
* **Management Station** — Automation execution host with line-of-sight to management network

=== Security Model

All credential handling follows the principle of least privilege:

* Credentials are **never hardcoded** in scripts or configuration files
* Three credential retrieval modes: Azure Key Vault, interactive prompt, or parameter injection
* Key Vault access via managed identity or service principal
* CI/CD pipelines use GitHub Secrets / Azure DevOps Service Connections / GitLab CI Variables
* All credential access is logged (value masked) for audit trail
